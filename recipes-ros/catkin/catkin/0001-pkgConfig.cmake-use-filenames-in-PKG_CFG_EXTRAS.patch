From 0f10cb9e60b4556e80535c4d67183f056520f4ab Mon Sep 17 00:00:00 2001
From: Stefan Herbrechtsmeier <stefan@herbrechtsmeier.net>
Date: Tue, 26 Feb 2013 16:46:27 +0100
Subject: [PATCH 1/2] pkgConfig.cmake: use filenames in PKG_CFG_EXTRAS

Signed-off-by: Stefan Herbrechtsmeier <stefan@herbrechtsmeier.net>
---
 cmake/catkin_package.cmake         |   16 ++++++++++------
 cmake/templates/pkgConfig.cmake.in |    4 +++-
 2 files changed, 13 insertions(+), 7 deletions(-)

diff --git a/cmake/catkin_package.cmake b/cmake/catkin_package.cmake
index 7c37d03..c758dae 100644
--- a/cmake/catkin_package.cmake
+++ b/cmake/catkin_package.cmake
@@ -328,7 +328,7 @@ function(_catkin_package)
         ${CMAKE_CURRENT_BINARY_DIR}/catkin_generated/${extra}.develspace.context.cmake.py
         ${em_template}
         ${CATKIN_DEVEL_PREFIX}/share/${PROJECT_NAME}/cmake/${extra})
-      list(APPEND PKG_CFG_EXTRAS ${CATKIN_DEVEL_PREFIX}/share/${PROJECT_NAME}/cmake/${extra})
+      list(APPEND PKG_CFG_EXTRAS ${extra})
     elseif(EXISTS ${base}.in OR EXISTS ${base}.develspace.in)
       if(EXISTS ${base}.develspace.in)
         set(in_template ${base}.develspace.in)
@@ -339,9 +339,13 @@ function(_catkin_package)
         ${CATKIN_DEVEL_PREFIX}/share/${PROJECT_NAME}/cmake/${extra}
         @ONLY
       )
-      list(APPEND PKG_CFG_EXTRAS ${CATKIN_DEVEL_PREFIX}/share/${PROJECT_NAME}/cmake/${extra})
+      list(APPEND PKG_CFG_EXTRAS ${extra})
     elseif(EXISTS ${base})
-      list(APPEND PKG_CFG_EXTRAS ${base})
+      configure_file(${base}
+        ${CATKIN_DEVEL_PREFIX}/share/${PROJECT_NAME}/cmake/${extra}
+        COPYONLY
+      )
+      list(APPEND PKG_CFG_EXTRAS ${extra})
     elseif(NOT EXISTS ${base}.installspace.em AND NOT EXISTS ${base}.installspace.in)
       message(FATAL_ERROR "catkin_package() could not find CFG_EXTRAS file.  Either 'cmake/${extra}.develspace.em', 'cmake/${extra}.em', 'cmake/${extra}.develspace.in', 'cmake/${extra}.in', 'cmake/${extra}' or a variant specific to the installspace must exist.")
     endif()
@@ -430,7 +434,7 @@ function(_catkin_package)
         ${em_template}
         ${CMAKE_CURRENT_BINARY_DIR}/catkin_generated/installspace/${extra})
       list(APPEND installable_cfg_extras ${CMAKE_CURRENT_BINARY_DIR}/catkin_generated/installspace/${extra})
-      list(APPEND PKG_CFG_EXTRAS ${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}/cmake/${extra})
+      list(APPEND PKG_CFG_EXTRAS ${extra})
     elseif(EXISTS ${base}.in OR EXISTS ${base}.installspace.in)
       if(EXISTS ${base}.installspace.in)
         set(in_template ${base}.installspace.in)
@@ -442,10 +446,10 @@ function(_catkin_package)
         @ONLY
       )
       list(APPEND installable_cfg_extras ${CMAKE_CURRENT_BINARY_DIR}/catkin_generated/installspace/${extra})
-      list(APPEND PKG_CFG_EXTRAS ${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}/cmake/${extra})
+      list(APPEND PKG_CFG_EXTRAS ${extra})
     elseif(EXISTS ${base})
       list(APPEND installable_cfg_extras ${base})
-      list(APPEND PKG_CFG_EXTRAS ${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}/cmake/${extra})
+      list(APPEND PKG_CFG_EXTRAS ${extra})
     elseif(NOT EXISTS ${base}.develspace.em AND NOT EXISTS ${base}.develspace.in)
       message(FATAL_ERROR "catkin_package() could not find CFG_EXTRAS file.  Either 'cmake/${extra}.installspace.em', 'cmake/${extra}.em', 'cmake/${extra}.installspace.in', 'cmake/${extra}.in', 'cmake/${extra}'or a variant specific to the develspace must exist.")
     endif()
diff --git a/cmake/templates/pkgConfig.cmake.in b/cmake/templates/pkgConfig.cmake.in
index 03e8a1c..0ee9231 100644
--- a/cmake/templates/pkgConfig.cmake.in
+++ b/cmake/templates/pkgConfig.cmake.in
@@ -70,6 +70,8 @@ else()
   set(@PROJECT_NAME@_PREFIX ${@PROJECT_NAME@_INSTALL_PREFIX})
 endif()
 
+set(@PROJECT_NAME@_EXTRAS_DIR ${CMAKE_CURRENT_LIST_DIR})
+
 # warn when using a deprecated package
 if(NOT "@PROJECT_DEPRECATED@" STREQUAL "")
   set(_msg "WARNING: package '@PROJECT_NAME@' is deprecated")
@@ -165,5 +167,5 @@ if(@PROJECT_NAME@_LIBRARIES)
 endif()
 
 foreach(extra @PKG_CFG_EXTRAS@)
-  include(${extra})
+  include(${@PROJECT_NAME@_EXTRAS_DIR}/${extra})
 endforeach()
-- 
1.7.0.4

